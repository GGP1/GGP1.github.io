<!doctype html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta http-equiv=Accept-CH content="DPR, Viewport-Width, Width"><link rel=icon href=/favicon.ico type=image/gif><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Alata&family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Alata&family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" media=print onload='this.media="all"'><noscript><link href="https://fonts.googleapis.com/css2?family=Alata&family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel=stylesheet></noscript><link rel=stylesheet href=/css/font.css media=all><meta property="og:url" content="https://gastonpalomeque.com/posts/mastering_sql_with_go_p1/"><meta property="og:site_name" content="Gastón Palomeque"><meta property="og:title" content="Mastering SQL with Go - Part 1"><meta property="og:description" content="I found myself using SQL a lot in one of my projects and I have learnt many things while trying to solve the problems I encountered.
This post is the part one of a series where I will try to show how to manage data in a relational database using SQL (Postgre syntax), Go and its standard library package database/sql.
Explaining absolutely everything would require an entire book so I will skip the subjects that most articles already cover (connection establishment, foreign keys, parameterized arguments, etc)."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-11-24T00:00:00+00:00"><meta property="article:modified_time" content="2024-11-24T00:00:00+00:00"><meta property="article:tag" content="Go"><meta property="article:tag" content="SQL"><meta name=twitter:card content="summary"><meta name=twitter:title content="Mastering SQL with Go - Part 1"><meta name=twitter:description content="I found myself using SQL a lot in one of my projects and I have learnt many things while trying to solve the problems I encountered.
This post is the part one of a series where I will try to show how to manage data in a relational database using SQL (Postgre syntax), Go and its standard library package database/sql.
Explaining absolutely everything would require an entire book so I will skip the subjects that most articles already cover (connection establishment, foreign keys, parameterized arguments, etc)."><link rel=stylesheet href=/bootstrap-5/css/bootstrap.min.css media=all><link rel=stylesheet href=/css/header.css media=all><link rel=stylesheet href=/css/footer.css media=all><link rel=stylesheet href=/css/theme.css media=all><style>:root{--text-color:#000;--text-secondary-color:#6c757d;--text-link-color:#4d7fb5;--background-color:#eaedf0;--secondary-background-color:#64ffda1a;--primary-color:#4d7fb5;--secondary-color:#f8f9fa;--text-color-dark:#e4e6eb;--text-secondary-color-dark:#b0b3b8;--text-link-color-dark:#ffffff;--background-color-dark:#18191a;--secondary-background-color-dark:#212529;--primary-color-dark:#ffffff;--secondary-color-dark:#212529}body{font-size:1rem;font-weight:400;line-height:1.5;text-align:left}html{background-color:var(--background-color)!important}body::-webkit-scrollbar{height:0;width:8px;background-color:var(--background-color)}::-webkit-scrollbar-track{border-radius:1rem}::-webkit-scrollbar-thumb{border-radius:1rem;background:#b0b0b0;outline:1px solid var(--background-color)}#search-content::-webkit-scrollbar{width:.5em;height:.1em;background-color:var(--background-color)}</style><meta name=description content><link rel=stylesheet href=/css/single.css><script defer src=/fontawesome-6/all-6.4.2.js></script><title>Mastering SQL with Go - Part 1 | Gastón Palomeque</title></head><body class=light><script>let localStorageValue=localStorage.getItem("pref-theme"),mediaQuery=window.matchMedia("(prefers-color-scheme: dark)").matches;switch(localStorageValue){case"dark":document.body.classList.add("dark");break;case"light":document.body.classList.remove("dark");break;default:mediaQuery&&document.body.classList.add("dark");break}</script><script>var prevScrollPos=window.pageYOffset;window.addEventListener("scroll",function(){let s=document.getElementById("profileHeader"),t=window.pageYOffset,n=!1,o=!0,i=o?prevScrollPos>t:t>0;i?s.classList.add("showHeaderOnTop"):n=!0,t===0&&(n=!0),n&&s.classList.remove("showHeaderOnTop"),prevScrollPos=t})</script><header id=profileHeader><nav class="pt-3 navbar navbar-expand-lg animate"><div class="container-fluid mx-xs-2 mx-sm-5 mx-md-5 mx-lg-5"><a class="navbar-brand primary-font text-wrap" href=/><img src=/favicon.ico width=30 height=30 class="d-inline-block align-top"></a><div><input id=search autocomplete=off class="form-control mr-sm-2 d-none d-md-block" placeholder=Search aria-label=Search oninput=searchOnChange(event)></div><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarContent aria-controls=navbarContent aria-expanded=false aria-label="Toggle navigation">
<svg aria-hidden="true" height="24" viewBox="0 0 16 16" width="24" data-view-component="true"><path fill-rule="evenodd" d="M1 2.75A.75.75.0 011.75 2h12.5a.75.75.0 110 1.5H1.75A.75.75.0 011 2.75zm0 5A.75.75.0 011.75 7h12.5a.75.75.0 110 1.5H1.75A.75.75.0 011 7.75zM1.75 12a.75.75.0 100 1.5h12.5a.75.75.0 100-1.5H1.75z"/></svg></button><div class="collapse navbar-collapse text-wrap primary-font" id=navbarContent><ul class="navbar-nav ms-auto text-center"><li class="nav-item navbar-text d-block d-md-none"><div class=nav-link><input id=search autocomplete=off class="form-control mr-sm-2" placeholder=Search aria-label=Search oninput=searchOnChange(event)></div></li><li class="nav-item navbar-text"><a class=nav-link href=/#about aria-label=about>About</a></li><li class="nav-item navbar-text"><a class=nav-link href=/#experience aria-label=experience>Experience</a></li><li class="nav-item navbar-text"><a class=nav-link href=/#projects aria-label=projects>Projects</a></li><li class="nav-item navbar-text"><a class=nav-link href=/posts/ title>Posts</a></li><li class="nav-item navbar-text"><div class=text-center><button id=theme-toggle>
<svg id="moon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></li></ul></div></div></nav></header><div id=content><section id=single><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-md-12 col-lg-9"><div class=pr-lg-4><div class="title mb-5"><h1 class="text-center mb-4">Mastering SQL with Go - Part 1</h1><div class=text-center>Nov 24, 2024</div></div><div class=featured-image><img class="img-fluid mx-auto d-block" src=/images/sql_go_p1.png alt="Mastering SQL with Go - Part 1"></div><article class="page-content p-2"><p>I found myself using SQL a lot in one of my projects and I have learnt many things while trying to solve the problems I encountered.</p><p>This post is the part one of a series where I will try to show how to manage data in a relational database using SQL (Postgre syntax), Go and its standard library package <a href=https://github.com/golang/go/tree/master/src/database/sql><code>database/sql</code></a>.</p><p>Explaining absolutely everything would require an entire book so I will skip the subjects that most articles already cover (connection establishment, foreign keys, parameterized arguments, etc).</p><h2 id=connection-tuning>Connection tuning</h2><p>When we connect to an SQL database through a driver and using the <code>database/sql</code> package we get the <a href=https://pkg.go.dev/database/sql#DB><code>sql.DB</code></a> database handle, which manages a pool of active connections that are safe for concurrent use, creating new ones when required.</p><blockquote><p>To perform actions on a dedicated connection, we can use <a href=https://pkg.go.dev/database/sql#Conn><code>sql.Conn</code></a>.</p></blockquote><p>The management of these connections can be personalized by using the following methods:</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#7f848e>// Set the maximum number of concurrent open connections.</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// There is no limit defined by default.</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// After the limit is passed, new datatabase operations will block </span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// until there&#39;s an available connection.</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>db</span>.<span style=color:#61afef;font-weight:700>SetMaxOpenConns</span>(<span style=color:#e06c75>n</span> <span style=color:#e5c07b>int</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// Set a connection&#39;s maximum life time.</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// Default is 2.</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// Increasing this value will improve the database performance at the</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// cost of consuming more memory to keep the connections alive.</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>db</span>.<span style=color:#61afef;font-weight:700>SetMaxIdleConns</span>(<span style=color:#e06c75>n</span> <span style=color:#e5c07b>int</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// Set a connection&#39;s maximum life time, once the time is reached it </span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// cannot be used again.</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// By default connections are reused forever.</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// Every one second the `database/sql` package removes expired connections </span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// from the pool.</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>db</span>.<span style=color:#61afef;font-weight:700>SetConnMaxLifetime</span>(<span style=color:#e06c75>d</span> <span style=color:#e06c75>time</span>.<span style=color:#e06c75>Duration</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// Set a connection&#39;s maximum idle time.</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// No value is set by default, connections may be idle their entire lifetime.</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>db</span>.<span style=color:#61afef;font-weight:700>SetConnMaxIdleTime</span>(<span style=color:#e06c75>d</span> <span style=color:#e06c75>time</span>.<span style=color:#e06c75>Duration</span>) 
</span></span></code></pre></div><p>The recommended values for these configurations depend on the type of application the database is used for, it may be convenient to specify and tweak them on the fly based on metrics gathered.</p><p>I personally prefer to begin limiting the maximum number and time of <strong>idle</strong> connections to avoid holding them for a long period of time (i.e. a burst of requests may open many connections that later won&rsquo;t be used anymore).</p><blockquote><p>A simple and useful way of getting more information about the database connection is the <a href=https://pkg.go.dev/database/sql#DB.Stats><code>db.Stats()</code></a> method.</p></blockquote><h2 id=scanning-null-values>Scanning null values</h2><p>If we attempt to scan a null value into a non-pointer variable we will receive an error saying that a null value can&rsquo;t be scanned into a Go type. There are (at least) three ways to address this problem:</p><h3 id=coalesce>COALESCE</h3><p>The <em>COALESCE</em> function takes <em>n</em> arguments and returns the first one that is not null, hence, we can use the targeted field as the first argument and then a default value to be returned when the first one is null.</p><p>The query would be as follows:</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#98c379>&#34;SELECT COALESCE(description, &#39;&#39;) as description FROM posts WHERE id=&#39;sample&#34;</span>
</span></span></code></pre></div><h3 id=standard-library-types>Standard library types</h3><p>The <code>database/sql</code> package has various types for scanning potentially null values (<code>sql.NullString</code>, <code>sql.NullInt</code>, <code>sql.NullBool</code>, etc.)</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#7f848e>// SELECT description FROM posts WHERE id=&#39;sample&#39;;</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>func</span> <span style=color:#61afef;font-weight:700>scanString</span>(<span style=color:#e06c75>row</span> <span style=color:#56b6c2>*</span><span style=color:#e06c75>sql</span>.<span style=color:#e06c75>Row</span>) (<span style=color:#e5c07b>string</span>, <span style=color:#e5c07b>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#c678dd>var</span> <span style=color:#e06c75>nullable</span> <span style=color:#e06c75>sql</span>.<span style=color:#e06c75>NullString</span>
</span></span><span style=display:flex><span>	<span style=color:#c678dd>if</span> <span style=color:#e06c75>err</span> <span style=color:#56b6c2>:=</span> <span style=color:#e06c75>row</span>.<span style=color:#61afef;font-weight:700>Scan</span>(<span style=color:#56b6c2>&amp;</span><span style=color:#e06c75>nullable</span>); <span style=color:#e06c75>err</span> <span style=color:#56b6c2>!=</span> <span style=color:#e5c07b>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#c678dd>return</span> <span style=color:#98c379>&#34;&#34;</span>, <span style=color:#e06c75>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#7f848e>// We can check if the value is null by using the nullable.Valid field.</span>
</span></span><span style=display:flex><span>	<span style=color:#c678dd>if</span> !<span style=color:#e06c75>nullable</span>.<span style=color:#e06c75>Valid</span> {
</span></span><span style=display:flex><span>		<span style=color:#7f848e>// nullable is null</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#c678dd>return</span> <span style=color:#e06c75>nullable</span>.<span style=color:#e06c75>String</span>, <span style=color:#e5c07b>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=pointers>Pointers</h3><p>The last option, and probably the most used one, is to declare a pointer that will be equal to <code>nil</code> in case there is no value stored.</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#7f848e>// SELECT description FROM posts WHERE id=&#39;sample&#39;;</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>func</span> <span style=color:#61afef;font-weight:700>scanString</span>(<span style=color:#e06c75>row</span> <span style=color:#56b6c2>*</span><span style=color:#e06c75>sql</span>.<span style=color:#e06c75>Row</span>) (<span style=color:#56b6c2>*</span><span style=color:#e5c07b>string</span>, <span style=color:#e5c07b>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#c678dd>var</span> <span style=color:#e06c75>nullable</span> <span style=color:#56b6c2>*</span><span style=color:#e5c07b>string</span>
</span></span><span style=display:flex><span>	<span style=color:#c678dd>if</span> <span style=color:#e06c75>err</span> <span style=color:#56b6c2>:=</span> <span style=color:#e06c75>row</span>.<span style=color:#61afef;font-weight:700>Scan</span>(<span style=color:#56b6c2>&amp;</span><span style=color:#e06c75>nullable</span>); <span style=color:#e06c75>err</span> <span style=color:#56b6c2>!=</span> <span style=color:#e5c07b>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#c678dd>return</span> <span style=color:#98c379>&#34;&#34;</span>, <span style=color:#e06c75>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#c678dd>return</span> <span style=color:#e06c75>nullable</span>, <span style=color:#e5c07b>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=storing-slices>Storing slices</h2><p>Storing a list of items that correspond to an object is generally done by using a new table and a foreign key to link both records.</p><p>However, in the case of simple data types like text and integer we can use <code>text[]</code> and <code>integer[]</code> respectively.</p><p>This isn&rsquo;t only simpler but it doesn&rsquo;t require to create a new table and one new row per slice element.</p><blockquote><p>For further information, see the <a href=https://www.postgresql.org/docs/14/arrays.html>official docs</a>.</p></blockquote><p>Let&rsquo;s take a look at how to store a string slice in PostgreSQL with Go:</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#7f848e>// Package &#34;github.com/lib/pq&#34; required</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>//
</span></span></span><span style=display:flex><span><span style=color:#7f848e>// `keys` field is of type text[]</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>func</span> <span style=color:#61afef;font-weight:700>insertKeys</span>(<span style=color:#e06c75>db</span> <span style=color:#56b6c2>*</span><span style=color:#e06c75>sql</span>.<span style=color:#e06c75>DB</span>, <span style=color:#e06c75>id</span> <span style=color:#e5c07b>string</span>, <span style=color:#e06c75>keys</span> <span style=color:#e06c75>pq</span>.<span style=color:#e06c75>StringArray</span>) <span style=color:#e5c07b>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#e06c75>_</span>, <span style=color:#e06c75>err</span> <span style=color:#56b6c2>:=</span> <span style=color:#e06c75>db</span>.<span style=color:#61afef;font-weight:700>Exec</span>(<span style=color:#98c379>&#34;INSERT INTO users (keys) VALUES ($2) WHERE id=$1&#34;</span>, <span style=color:#e06c75>id</span>, <span style=color:#e06c75>keys</span>)
</span></span><span style=display:flex><span>	<span style=color:#c678dd>if</span> <span style=color:#e06c75>err</span> <span style=color:#56b6c2>!=</span> <span style=color:#e5c07b>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#c678dd>return</span> <span style=color:#e06c75>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#c678dd>return</span> <span style=color:#e5c07b>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// pq.StringArray underlying type is []string</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>func</span> <span style=color:#61afef;font-weight:700>getKeys</span>(<span style=color:#e06c75>db</span> <span style=color:#56b6c2>*</span><span style=color:#e06c75>sql</span>.<span style=color:#e06c75>DB</span>, <span style=color:#e06c75>id</span> <span style=color:#e5c07b>string</span>) ([]<span style=color:#e5c07b>string</span>, <span style=color:#e5c07b>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#e06c75>row</span> <span style=color:#56b6c2>:=</span> <span style=color:#e06c75>db</span>.<span style=color:#61afef;font-weight:700>QueryRow</span>(<span style=color:#98c379>&#34;SELECT keys FROM users WHERE id=$1&#34;</span>, <span style=color:#e06c75>id</span>)
</span></span><span style=display:flex><span>	<span style=color:#c678dd>var</span> <span style=color:#e06c75>keys</span> <span style=color:#e06c75>pq</span>.<span style=color:#e06c75>StringArray</span>
</span></span><span style=display:flex><span>	<span style=color:#c678dd>if</span> <span style=color:#e06c75>err</span> <span style=color:#56b6c2>:=</span> <span style=color:#e06c75>row</span>.<span style=color:#61afef;font-weight:700>Scan</span>(<span style=color:#56b6c2>&amp;</span><span style=color:#e06c75>keys</span>); <span style=color:#e06c75>err</span> <span style=color:#56b6c2>!=</span> <span style=color:#e5c07b>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#c678dd>return</span> <span style=color:#e5c07b>nil</span>, <span style=color:#e06c75>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#c678dd>return</span> <span style=color:#e06c75>keys</span>, <span style=color:#e5c07b>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=update-only-what-changes>Update only what changes</h2><p>The <a href=#coalesce>COALESCE</a> function we&rsquo;ve seen above is also handy for updating only the fields that the user specified a value for.</p><p>Consider a scenario where we want the users to update a post&rsquo;s content, the image or both.</p><p>We will use string pointers for our struct fields to distinguish null values, otherwise we wouldn&rsquo;t know whether the user wants to store and empty string or to not change anything.</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#c678dd>type</span> <span style=color:#e06c75>UpdatePost</span> <span style=color:#c678dd>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#e06c75>Content</span> <span style=color:#56b6c2>*</span><span style=color:#e5c07b>string</span>
</span></span><span style=display:flex><span>	<span style=color:#e06c75>Image</span> <span style=color:#56b6c2>*</span><span style=color:#e5c07b>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>func</span> <span style=color:#61afef;font-weight:700>updatePost</span>(<span style=color:#e06c75>db</span> <span style=color:#56b6c2>*</span><span style=color:#e06c75>sql</span>.<span style=color:#e06c75>DB</span>, <span style=color:#e06c75>id</span> <span style=color:#e5c07b>string</span>, <span style=color:#e06c75>post</span> <span style=color:#e06c75>UpdatePost</span>) <span style=color:#e5c07b>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#e06c75>q</span> <span style=color:#56b6c2>:=</span> <span style=color:#98c379>`UPDATE posts SET 
</span></span></span><span style=display:flex><span><span style=color:#98c379>	content = COALESCE($2, content)
</span></span></span><span style=display:flex><span><span style=color:#98c379>	image = COALESCE($3, image)
</span></span></span><span style=display:flex><span><span style=color:#98c379>	WHERE id = $1`</span>
</span></span><span style=display:flex><span>	<span style=color:#e06c75>_</span>, <span style=color:#e06c75>err</span> <span style=color:#56b6c2>:=</span> <span style=color:#e06c75>db</span>.<span style=color:#61afef;font-weight:700>Exec</span>(<span style=color:#e06c75>q</span>, <span style=color:#e06c75>id</span>, <span style=color:#e06c75>post</span>.<span style=color:#e06c75>Content</span>, <span style=color:#e06c75>post</span>.<span style=color:#e06c75>Image</span>)
</span></span><span style=display:flex><span>	<span style=color:#c678dd>return</span> <span style=color:#e06c75>err</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This way, if the user updated the content only, COALESCE will detect that the image argument is null and thus use the already stored value, leaving the field as it was prior to the update.</p><h2 id=batch-inserts>Batch inserts</h2><p>Inserting multiple records at once is typically an expensive operation and that&rsquo;s why we need an optimal solution for it.</p><h3 id=bulk-imports>Bulk imports</h3><p>The <code>COPY</code> command is optimized for loading large numbers of rows; it is less flexible than <code>INSERT</code>, but incurs significantly less overhead for large data loads.</p><p>Since it&rsquo;s a single command, there is no need to disable autocommit if you use this method to populate a table. Also, it stops operation at the first error.</p><p><code>COPY FROM</code> will invoke any triggers and check constraints on the destination table. However, it will not invoke rules.</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#c678dd>func</span> <span style=color:#61afef;font-weight:700>bulkImports</span>(<span style=color:#e06c75>db</span> <span style=color:#56b6c2>*</span><span style=color:#e06c75>sql</span>.<span style=color:#e06c75>DB</span>, <span style=color:#e06c75>posts</span> []<span style=color:#e06c75>Post</span>) <span style=color:#e5c07b>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#e06c75>stmt</span>, <span style=color:#e06c75>err</span> <span style=color:#56b6c2>:=</span> <span style=color:#e06c75>db</span>.<span style=color:#61afef;font-weight:700>Prepare</span>(<span style=color:#98c379>&#34;COPY posts (id, title, content) FROM STDIN&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#c678dd>if</span> <span style=color:#e06c75>err</span> <span style=color:#56b6c2>!=</span> <span style=color:#e5c07b>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#c678dd>return</span> <span style=color:#e06c75>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#c678dd>defer</span> <span style=color:#e06c75>stmt</span>.<span style=color:#61afef;font-weight:700>Close</span>()
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#c678dd>for</span> <span style=color:#e06c75>_</span>, <span style=color:#e06c75>post</span> <span style=color:#56b6c2>:=</span> <span style=color:#c678dd>range</span> <span style=color:#e06c75>posts</span> {
</span></span><span style=display:flex><span>		<span style=color:#e06c75>_</span>, <span style=color:#e06c75>err</span> <span style=color:#56b6c2>:=</span> <span style=color:#e06c75>stmt</span>.<span style=color:#61afef;font-weight:700>ExecContext</span>(<span style=color:#e06c75>ctx</span>, <span style=color:#e06c75>post</span>.<span style=color:#e06c75>ID</span>, <span style=color:#e06c75>post</span>.<span style=color:#e06c75>Title</span>, <span style=color:#e06c75>post</span>.<span style=color:#e06c75>Content</span>)
</span></span><span style=display:flex><span>		<span style=color:#c678dd>if</span> <span style=color:#e06c75>err</span> <span style=color:#56b6c2>!=</span> <span style=color:#e5c07b>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#c678dd>return</span> <span style=color:#e06c75>err</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#7f848e>// Flush buffered data</span>
</span></span><span style=display:flex><span>	<span style=color:#c678dd>if</span> <span style=color:#e06c75>_</span>, <span style=color:#e06c75>err</span> <span style=color:#56b6c2>:=</span> <span style=color:#e06c75>stmt</span>.<span style=color:#61afef;font-weight:700>ExecContext</span>(<span style=color:#e06c75>ctx</span>); <span style=color:#e06c75>err</span> <span style=color:#56b6c2>!=</span> <span style=color:#e5c07b>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#c678dd>return</span> <span style=color:#e06c75>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#c678dd>return</span> <span style=color:#e5c07b>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=query-building>Query building</h3><p>Another way to insert multiple records in one call is to build a query containing a set of arguments for each of them.</p><p>For example:</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#98c379>&#34;INSERT INTO posts (id, title, content, image) VALUES ($1, $2, $3), ($4, $5, $6)&#34;</span>
</span></span></code></pre></div><blockquote><p>Take a look at the implementation <a href=https://stackoverflow.com/questions/12486436/how-do-i-batch-sql-statements-with-package-database-sql>here</a>.</p><p>Note that the maximum number of arguments supported by <code>VALUES</code> is 1000.</p></blockquote><h2 id=pagination>Pagination</h2><p>Pagination is the process of dividing a document into discrete pages.</p><p>In programming, we provide our clients the possibility to paginate the list of results by using a cursor.</p><p>A cursor could be thought as a flag that divides already seen records and not yet seen ones.</p><p>On each request, we return a new cursor (which may be an id or an encoded string) so the user can ask for more records without getting repeated ones.</p><p>Here are two common ways of implementing pagination in SQL that are safe from injection:</p><h3 id=using-uuids>Using UUIDs</h3><p>We select the posts that were created before the date passed, in case the date matches with the creation timestamp, the ID is compared.</p><blockquote><p>In this case, the cursor is generally an encoded string that contains both the ID and the creation timestamp.</p></blockquote><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#7f848e>// Requires the table to have a field with a timestamp of the value creation</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>id</span> <span style=color:#56b6c2>:=</span> <span style=color:#98c379>&#34;3c0217ac-503f-45dc-b150-0b1618155d3d&#34;</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>createdAt</span> <span style=color:#56b6c2>:=</span> <span style=color:#e06c75>time</span>.<span style=color:#61afef;font-weight:700>Now</span>()
</span></span><span style=display:flex><span><span style=color:#e06c75>q</span> <span style=color:#56b6c2>:=</span> <span style=color:#98c379>`SELECT * FROM posts WHERE 
</span></span></span><span style=display:flex><span><span style=color:#98c379>created_at &lt; $1 OR (created_at = $1 AND id &lt; $2) 
</span></span></span><span style=display:flex><span><span style=color:#98c379>ORDER BY created_at DESC, id DESC LIMIT 5`</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>db</span>.<span style=color:#61afef;font-weight:700>Query</span>(<span style=color:#e06c75>q</span>, <span style=color:#e06c75>createdAt</span>, <span style=color:#e06c75>id</span>)
</span></span></code></pre></div><h3 id=using-lexicographically-sortable-ids>Using lexicographically sortable IDs</h3><p>Since the IDs are already sorted there is no need to compare the creation date, the ID is the cursor itself.</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#e06c75>id</span> <span style=color:#56b6c2>:=</span> <span style=color:#98c379>&#34;01FMA344NAGPSKF4TNAXMC06KS&#34;</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>db</span>.<span style=color:#61afef;font-weight:700>Query</span>(<span style=color:#98c379>&#34;SELECT * FROM posts WHERE id &lt; $1 ORDER BY id DESC LIMIT 5&#34;</span>, <span style=color:#e06c75>id</span>)
</span></span></code></pre></div><h2 id=prepared-statements>Prepared statements</h2><p>When we make a query using <a href=https://pkg.go.dev/database/sql#DB.Query><code>db.Query()</code></a>, a prepared statement is built underneath to run it, but it&rsquo;s used only once.</p><p>If we were to execute the same query multiple times, we would be wasting resources as the prepared statement would be compiled on each iteration.</p><p>In order to fix this, we can use <em>prepared statements</em>, they allow us to compile the query with parameterized arguments separetely and then use that statement <em>n</em> times.</p><p>Another advantage is that multiple queries or executions may be run concurrently from the returned statement.</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#e06c75>stmt</span>, <span style=color:#e06c75>err</span> <span style=color:#56b6c2>:=</span> <span style=color:#e06c75>db</span>.<span style=color:#61afef;font-weight:700>Prepare</span>(<span style=color:#98c379>&#34;SELECT * FROM posts WHERE id=$1&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#c678dd>if</span> <span style=color:#e06c75>err</span> <span style=color:#56b6c2>!=</span> <span style=color:#e5c07b>nil</span> {
</span></span><span style=display:flex><span>	<span style=color:#c678dd>return</span> <span style=color:#e06c75>err</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#7f848e>// Remember to always close the statement when </span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// it&#39;s no longer needed to free up resources</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>defer</span> <span style=color:#e06c75>stmt</span>.<span style=color:#61afef;font-weight:700>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>for</span> <span style=color:#e06c75>_</span>, <span style=color:#e06c75>id</span> <span style=color:#56b6c2>:=</span> <span style=color:#c678dd>range</span> <span style=color:#e06c75>postIDs</span> {
</span></span><span style=display:flex><span>	<span style=color:#c678dd>if</span> <span style=color:#e06c75>_</span>, <span style=color:#e06c75>err</span> <span style=color:#56b6c2>:=</span> <span style=color:#e06c75>stmt</span>.<span style=color:#61afef;font-weight:700>QueryRowContext</span>(<span style=color:#e06c75>ctx</span>, <span style=color:#e06c75>id</span>); <span style=color:#e06c75>err</span> <span style=color:#56b6c2>!=</span> <span style=color:#e5c07b>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#c678dd>return</span> <span style=color:#e06c75>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#7f848e>// Scan post</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=stored-procedures>Stored procedures</h2><p>Stored procedures are user-defined functions that can be stored in the database for later reuse, they can contain parameters but can&rsquo;t return anything.</p><p>As simple as that, let&rsquo;s implement a stored procedure for updating a post&rsquo;s likes:</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#7f848e>// Check if the user already liked the post, if yes, remove the like, if not, add it.</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>q</span> <span style=color:#56b6c2>:=</span> <span style=color:#98c379>`CREATE OR REPLACE PROCEDURE likePost(postID text, userID text) AS $$
</span></span></span><span style=display:flex><span><span style=color:#98c379>	BEGIN
</span></span></span><span style=display:flex><span><span style=color:#98c379>		IF EXISTS (SELECT 1 FROM post_likes WHERE post_id=postID AND user_id=userID) THEN
</span></span></span><span style=display:flex><span><span style=color:#98c379>	   		DELETE FROM post_likes WHERE post_id=postID AND user_id=userID;
</span></span></span><span style=display:flex><span><span style=color:#98c379>	   	ELSE
</span></span></span><span style=display:flex><span><span style=color:#98c379>	   		INSERT INTO post_likes (post_id, user_id) VALUES (postID, userID);
</span></span></span><span style=display:flex><span><span style=color:#98c379>	   	END IF;
</span></span></span><span style=display:flex><span><span style=color:#98c379>	END 
</span></span></span><span style=display:flex><span><span style=color:#98c379>$$ LANGUAGE plpgsql`</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>db</span>.<span style=color:#61afef;font-weight:700>ExecContext</span>(<span style=color:#e06c75>ctx</span>, <span style=color:#e06c75>q</span>)
</span></span></code></pre></div><p>We can execute it doing:</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#e06c75>db</span>.<span style=color:#61afef;font-weight:700>ExecContext</span>(<span style=color:#e06c75>ctx</span>, <span style=color:#98c379>&#34;CALL likePost($1, $2)&#34;</span>, <span style=color:#e06c75>postID</span>, <span style=color:#e06c75>userID</span>)
</span></span></code></pre></div><h2 id=parting-words>Parting words</h2><p>I hope you found this post useful, in the next one we will be taking a look at transactions (propagation using context and isolation levels), dynamic scanning, full text search, recursive queries and much more.</p></article></div></div><div class="col-sm-12 col-md-12 col-lg-3"><div id=stickySideBar class=sticky-sidebar><aside class=toc><h5>Table Of Contents</h5><div class=toc-content><nav id=TableOfContents><ul><li><a href=#connection-tuning>Connection tuning</a></li><li><a href=#scanning-null-values>Scanning null values</a><ul><li><a href=#coalesce>COALESCE</a></li><li><a href=#standard-library-types>Standard library types</a></li><li><a href=#pointers>Pointers</a></li></ul></li><li><a href=#storing-slices>Storing slices</a></li><li><a href=#update-only-what-changes>Update only what changes</a></li><li><a href=#batch-inserts>Batch inserts</a><ul><li><a href=#bulk-imports>Bulk imports</a></li><li><a href=#query-building>Query building</a></li></ul></li><li><a href=#pagination>Pagination</a><ul><li><a href=#using-uuids>Using UUIDs</a></li><li><a href=#using-lexicographically-sortable-ids>Using lexicographically sortable IDs</a></li></ul></li><li><a href=#prepared-statements>Prepared statements</a></li><li><a href=#stored-procedures>Stored procedures</a></li><li><a href=#parting-words>Parting words</a></li></ul></nav></div></aside><aside class=tags><h5>Tags</h5><ul class="tags-ul list-unstyled list-inline"><li class=list-inline-item><a href=https://gastonpalomeque.com/tags/go>Go</a></li><li class=list-inline-item><a href=https://gastonpalomeque.com/tags/sql>SQL</a></li></ul></aside></div></div></div><div class=row><div class="col-sm-12 col-md-12 col-lg-9 p-4"></div></div></div><button class="p-2 px-3" onclick=topFunction() id=topScroll>
<i class="fas fa-angle-up"></i></button></section><script>var topScroll=document.getElementById("topScroll");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?topScroll.style.display="block":topScroll.style.display="none"}function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}let stickySideBarElem=document.getElementById("stickySideBar"),stickyNavBar=!0;if(stickyNavBar){let e=document.getElementById("profileHeader"),t=e.offsetHeight+15;stickySideBarElem.style.top=t+"px"}else stickySideBarElem.style.top="50px"</script></div><footer><div class=text-center><div class="text-center pt-2"><span class=px-1><a href=https://github.com/GGP1 aria-label=github><svg width="2.7em" height="2.7em" viewBox="0 0 1792 1792"><path id="footer-socialNetworks-github-svg-path" d="M522 1352q-8 9-20-3-13-11-4-19 8-9 20 3 12 11 4 19zm-42-61q9 12 0 19-8 6-17-7t0-18q9-7 17 6zm-61-60q-5 7-13 2-10-5-7-12 3-5 13-2 10 5 7 12zm31 34q-6 7-16-3-9-11-2-16 6-6 16 3 9 11 2 16zm129 112q-4 12-19 6-17-4-13-15t19-7q16 5 13 16zm63 5q0 11-16 11-17 2-17-11 0-11 16-11 17-2 17 11zm58-10q2 10-14 14t-18-8 14-15q16-2 18 9zm964-956v960q0 119-84.5 203.5T1376 1664h-224q-16 0-24.5-1t-19.5-5-16-14.5-5-27.5v-239q0-97-52-142 57-6 102.5-18t94-39 81-66.5 53-105T1386 856q0-121-79-206 37-91-8-204-28-9-81 11t-92 44l-38 24q-93-26-192-26t-192 26q-16-11-42.5-27T578 459.5 492 446q-44 113-7 204-79 85-79 206 0 85 20.5 150t52.5 105 80.5 67 94 39 102.5 18q-40 36-49 103-21 10-45 15t-57 5-65.5-21.5T484 1274q-19-32-48.5-52t-49.5-24l-20-3q-21 0-29 4.5t-5 11.5 9 14 13 12l7 5q22 10 43.5 38t31.5 51l10 23q13 38 44 61.5t67 30 69.5 7 55.5-3.5l23-4q0 38 .5 103t.5 68q0 22-11 33.5t-22 13-33 1.5H416q-119 0-203.5-84.5T128 1376V416q0-119 84.5-203.5T416 128h960q119 0 203.5 84.5T1664 416z"/></svg>
</a></span><span class=px-1><a href=https://linkedin.com/in/gastonpalomeque aria-label=linkedin><svg width="2.4em" height="2.4em" fill="#fff" aria-label="LinkedIn" viewBox="0 0 512 512"><rect width="512" height="512" fill="#0077b5" rx="15%"/><circle cx="142" cy="138" r="37"/><path stroke="#fff" stroke-width="66" d="M244 194v198M142 194v198"/><path d="M276 282c0-20 13-40 36-40 24 0 33 18 33 45v105h66V279c0-61-32-89-76-89-34 0-51 19-59 32"/></svg>
</a></span><span class=px-1><a href=https://stackoverflow.com/users/12574067/ggp aria-label=stackoverflow><svg viewBox="-24 0 304 304" width="1.8em" height="1.8em" xmlns:xlink="http://www.w3.org/1999/xlink" preserveAspectRatio="xMidYMid" fill="#000"><g id="SVGRepo_bgCarrier" stroke-width="0"/><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"/><g id="SVGRepo_iconCarrier"><g><polygon fill="#bcbbbb" points="216.329708 276.187929 216.329708 194.976776 243.28341 194.976776 243.28341 303.14163 0 303.14163 0 194.976776 26.9537015 194.976776 26.9537015 276.187929"/><path d="M56.7077876 187.275718 189.025959 214.929516 194.626728 188.325863 62.3085568 160.672065l-5.6007692 26.603653zm17.5024036-63.008653L196.727016 181.324901l11.201539-24.503365L85.4117295 99.4136524 74.2101912 124.267065zM108.164854 64.0587971 212.129132 150.520671l17.152355-20.652836L125.31721 43.4059609 108.164854 64.0587971zM175.374084.0l-21.70298 16.1022113L234.18216 124.617114l21.70298-16.102212L175.374084.0zM53.9074031 248.884179H189.025959V221.930478H53.9074031v26.953701z" fill="#f48023"/></g></g></svg></a></span></div><div class=py-3>Gastón Palomeque</div></div></footer><script src=/bootstrap-5/js/bootstrap.bundle.min.js></script><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))});var tooltipTriggerList=[].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]')),tooltipList=tooltipTriggerList.map(function(e){return new bootstrap.Tooltip(e)})</script><script src=/js/search.js></script><section id=search-content class=py-2><div class=container id=search-results></div></section></body></html>